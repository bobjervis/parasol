#!/bin/bash
set -e

PARASOL_BIN=$(dirname `readlink -f $0`)/..
export PARASOL_HOME=`readlink -f $PARASOL_BIN`

PARASOL_PXI=$PARASOL_HOME/bin/x86-64-lnx.pxi

$PARASOL_HOME/bin/parasolrt $PARASOL_PXI compiler/main.p --pxi=p1.pxi compiler/main.p

$PARASOL_HOME/bin/parasolrt  p1.pxi --pxi=p2.pxi compiler/main.p
if ! $PARASOL_HOME/bin/pc src/util/bdiff.p p1.pxi p2.pxi 
then
    echo Trying a third generation...
    $PARASOL_HOME/bin/parasolrt  p2.pxi --pxi=p3.pxi compiler/main.p
    if ! $PARASOL_HOME/bin/pc src/util/bdiff.p p2.pxi p3.pxi
    then
        echo  FAILED: binaries not converging after 3 generations
        exit 1
    fi
fi
$PARASOL_HOME/bin/parasolrt p2.pxi test/drivers/etsTests.p $@ --testpxi=p2.pxi test/scripts/parasol_tests.ets
cp p1.pxi $PARASOL_PXI
$PARASOL_HOME/bin/parasolrt $PARASOL_PXI $PARASOL_HOME/compiler/main.p --pxi=$PARASOL_HOME/bin/x86-64-win.pxi --target=x86-64-win $PARASOL_HOME/compiler/main.p
rm p1.pxi p2.pxi
echo SUCCESS
