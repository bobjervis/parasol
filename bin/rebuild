set -e
#!/bin/bash

PARASOL_BIN=$(dirname `readlink -f $0`)/..
export PARASOL_HOME=`readlink -f $PARASOL_BIN`

PARASOL_PXI=$PARASOL_HOME/Debug/x86-64lnx.pxi

$PARASOL_HOME/bin/parasolrt $PARASOL_PXI compiler/main.p --pxi=p1.pxi compiler/main.p

$PARASOL_HOME/bin/parasolrt  p1.pxi --pxi=p2.pxi compiler/main.p
$PARASOL_HOME/bin/pc src/util/bdiff.p p1.pxi p2.pxi
$PARASOL_HOME/bin/parasolrt p2.pxi test/drivers/etsTests.p $@ --testpxi=p2.pxi test/scripts/parasol_tests.ets
cp $PARASOL_PXI ${PARASOL_PXI}.save
cp p1.pxi $PARASOL_PXI
$PARASOL_HOME/bin/parasolrt $PARASOL_PXI compiler/main.p --pxi=Debug/x86-64-win.pxi --target=x86-64-win compiler/main.p
echo SUCCESS
