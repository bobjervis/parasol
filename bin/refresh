#!/bin/bash
set -e

PARASOL_BIN=$(dirname "`readlink -f \"$0\"`")/..
export PARASOL_HOME=`readlink -f "$PARASOL_BIN"`

PARASOL_PXI=$PARASOL_HOME/bin/x86-64-lnx.pxi

mkdir -p "$PARASOL_HOME/build"

(cd "$PARASOL_HOME"; make -f runtime/makefile)

"$PARASOL_HOME/build/parasolrt" "$PARASOL_PXI" "$PARASOL_HOME/compiler/main.p" "--pxi=$PARASOL_HOME/build/p1.pxi" "$PARASOL_HOME/compiler/main.p"

"$PARASOL_HOME/build/parasolrt"  "$PARASOL_HOME/build/p1.pxi" "--pxi=$PARASOL_HOME/build/p2.pxi" "$PARASOL_HOME/compiler/main.p"
if ! "$PARASOL_HOME/bin/pc" "$PARASOL_HOME/src/util/bdiff.p" "$PARASOL_HOME/build/p1.pxi" "$PARASOL_HOME/build/p2.pxi"
then
    echo Trying a third generation...
    "$PARASOL_HOME/build/parasolrt"  "$PARASOL_HOME/build/p2.pxi" "--pxi=$PARASOL_HOME/build/p3.pxi" "$PARASOL_HOME/compiler/main.p"
    if ! "$PARASOL_HOME/bin/pc" "$PARASOL_HOME/src/util/bdiff.p" "$PARASOL_HOME/build/p2.pxi" "$PARASOL_HOME/build/p3.pxi"
    then
        echo  FAILED: binaries not converging after 3 generations
        exit 1
    fi
fi
cd "$PARASOL_HOME"
build/parasolrt "$PARASOL_PXI" compiler/main.p --pxi=bin/x86-64-win.pxi --target=x86-64-win compiler/main.p
#
# Can't use bdiff.p for these next file compares, since the compiler is not fully upgraded until all three files are in sync
#
if ! diff -q "$PARASOL_HOME/build/p1.pxi" "$PARASOL_PXI"
then
    cp "$PARASOL_HOME/build/p1.pxi" "$PARASOL_PXI"
else
	echo skipping x86-64-lnx.pxi
fi
if ! diff -q "$PARASOL_HOME/build/parasolrt" "$PARASOL_HOME/bin/parasolrt"
then
    cp "$PARASOL_HOME/build/parasolrt" "$PARASOL_HOME/bin/parasolrt"
else
	echo skipping parasolrt
fi
if ! diff -q "$PARASOL_HOME/build/libparasol.so.1" "$PARASOL_HOME/bin/libparasol.so.1"
then
    cp "$PARASOL_HOME/build/libparasol.so.1" "$PARASOL_HOME/bin/libparasol.so.1"
else
	echo skipping libparasol.so.1
fi
echo SUCCESS
